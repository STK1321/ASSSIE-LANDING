---
import Button from "@/components/atoms/Button.astro";
import Icon from "@/components/atoms/Icon.astro";
import type { Service } from "@/content/services";

const { services, whatsappLink } = Astro.props as { services: Service[]; whatsappLink: string };
const servicesData = JSON.stringify(services);
const whatsappUrl = JSON.stringify(whatsappLink);
---
<div
  class="fixed inset-0 z-50 hidden items-center justify-center bg-ink/50 px-4 py-8"
  data-service-modal
  aria-hidden="true"
>
  <div
    class="relative w-full max-w-3xl scale-95 rounded-3xl border border-white/70 bg-white p-8 shadow-card opacity-0 transition-all duration-200"
    role="dialog"
    aria-modal="true"
    aria-labelledby="service-modal-title"
    aria-describedby="service-modal-description"
  >
    <button
      type="button"
      class="absolute right-4 top-4 rounded-full border border-slate/20 p-2 text-slate transition hover:border-accent hover:text-accent"
      data-service-close
      aria-label="Cerrar modal"
    >
      <Icon name="close" class="h-4 w-4" />
    </button>

    <div class="space-y-4">
      <div>
        <p class="text-xs font-semibold uppercase tracking-[0.2em] text-accent" data-service-modal-label>
          Servicio
        </p>
        <h3 id="service-modal-title" class="mt-2 text-2xl font-semibold text-ink" data-service-modal-title></h3>
        <p class="mt-4 text-xs font-semibold uppercase tracking-[0.2em] text-slate">Descripción corta</p>
        <p id="service-modal-description" class="mt-2 text-sm text-slate" data-service-modal-description></p>
      </div>

      <div class="grid gap-6 lg:grid-cols-3">
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate">Ideal para</p>
          <ul class="mt-2 space-y-2 text-sm text-slate" data-service-modal-ideal></ul>
        </div>
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate">Alcance</p>
          <ul class="mt-2 space-y-2 text-sm text-slate" data-service-modal-scope></ul>
        </div>
        <div>
          <p class="text-xs font-semibold uppercase tracking-[0.2em] text-slate">Entregables</p>
          <ul class="mt-2 space-y-2 text-sm text-slate" data-service-modal-deliverables></ul>
        </div>
      </div>

      <div class="rounded-2xl border border-slate/10 bg-surface px-4 py-3 text-sm text-slate">
        Tiempo típico: <span class="font-semibold text-ink" data-service-modal-timeline></span>
      </div>

      <div class="flex flex-wrap gap-3">
        <Button as="button" type="button" variant="primary" data-service-modal-cta>
          Quiero este servicio
        </Button>
        <Button variant="ghost" href={whatsappLink} target="_blank" rel="noopener" data-service-modal-whatsapp>
          <Icon name="whatsapp" class="h-4 w-4" />
          WhatsApp
        </Button>
      </div>
    </div>
  </div>
</div>

<script is:inline>
  const services = ${servicesData};
  const whatsappUrl = ${whatsappUrl};

  const setupModal = () => {
    const modal = document.querySelector("[data-service-modal]");
    const modalPanel = modal?.querySelector("[role='dialog']");
    const openButtons = document.querySelectorAll("[data-service-open]");
    const closeButton = modal?.querySelector("[data-service-close]");
    const titleEl = modal?.querySelector("[data-service-modal-title]");
    const descriptionEl = modal?.querySelector("[data-service-modal-description]");
    const idealEl = modal?.querySelector("[data-service-modal-ideal]");
    const scopeEl = modal?.querySelector("[data-service-modal-scope]");
    const deliverablesEl = modal?.querySelector("[data-service-modal-deliverables]");
    const timelineEl = modal?.querySelector("[data-service-modal-timeline]");
    const ctaButton = modal?.querySelector("[data-service-modal-cta]");
    const whatsappButton = modal?.querySelector("[data-service-modal-whatsapp]");

    if (!modal || !modalPanel) return;

    let activeTrigger = null;
    let activeService = null;

    const orderLabels = {
      1: "1️⃣",
      2: "2️⃣",
      3: "3️⃣",
      4: "4️⃣",
      5: "5️⃣"
    };

    const focusableSelectors = [
      "a[href]",
      "button:not([disabled])",
      "textarea",
      "input",
      "select",
      "[tabindex]:not([tabindex='-1'])"
    ];

    const lockScroll = () => document.body.classList.add("overflow-hidden");
    const unlockScroll = () => document.body.classList.remove("overflow-hidden");

    const setContent = (service) => {
      if (!service) return;
      const label = orderLabels[service.order] ?? `${service.order}.`;
      if (titleEl) titleEl.textContent = `${label} ${service.title}`;
      if (descriptionEl) descriptionEl.textContent = service.description;
      if (timelineEl) timelineEl.textContent = service.typicalTimeline;
      if (ctaButton) ctaButton.textContent = service.modalCtaLabel;
      if (whatsappButton) whatsappButton.setAttribute("href", whatsappUrl);

      if (idealEl) {
        idealEl.innerHTML = "";
        service.idealFor.forEach((item) => {
          const li = document.createElement("li");
          li.className = "flex gap-2";
          li.innerHTML = `<span class="text-accent">✓</span><span>${item}</span>`;
          idealEl.appendChild(li);
        });
      }

      if (scopeEl) {
        scopeEl.innerHTML = "";
        service.scope.forEach((item) => {
          const li = document.createElement("li");
          li.className = "flex gap-2";
          li.innerHTML = `<span class="text-accent">✓</span><span>${item}</span>`;
          scopeEl.appendChild(li);
        });
      }

      if (deliverablesEl) {
        deliverablesEl.innerHTML = "";
        service.deliverables.forEach((item) => {
          const li = document.createElement("li");
          li.className = "flex gap-2";
          li.innerHTML = `<span class="text-accent">✓</span><span>${item}</span>`;
          deliverablesEl.appendChild(li);
        });
      }
    };

    const trapFocus = (event) => {
      if (!modalPanel || event.key !== "Tab") return;
      const focusable = Array.from(
        modalPanel.querySelectorAll(focusableSelectors.join(","))
      );
      if (!focusable.length) return;
      const first = focusable[0];
      const last = focusable[focusable.length - 1];
      if (event.shiftKey && document.activeElement === first) {
        event.preventDefault();
        last.focus();
      } else if (!event.shiftKey && document.activeElement === last) {
        event.preventDefault();
        first.focus();
      }
    };

    const openModal = (serviceId, trigger) => {
      const service = services.find((item) => item.id === serviceId);
      if (!service) return;
      activeTrigger = trigger;
      activeService = service;
      setContent(service);
      modal.classList.remove("hidden");
      modal.classList.add("flex");
      modal.setAttribute("aria-hidden", "false");
      lockScroll();

      requestAnimationFrame(() => {
        modalPanel.classList.remove("scale-95", "opacity-0");
        modalPanel.classList.add("scale-100", "opacity-100");
        const focusable = modalPanel.querySelectorAll(focusableSelectors.join(","));
        if (focusable.length) focusable[0].focus();
      });
    };

    const closeModal = () => {
      modalPanel.classList.add("scale-95", "opacity-0");
      modalPanel.classList.remove("scale-100", "opacity-100");
      setTimeout(() => {
        modal.classList.add("hidden");
        modal.classList.remove("flex");
        modal.setAttribute("aria-hidden", "true");
        unlockScroll();
        if (activeTrigger) activeTrigger.focus();
      }, 180);
    };

    openButtons.forEach((button) => {
      button.addEventListener("click", (event) => {
        event.preventDefault();
        const target = event.currentTarget;
        const serviceId = target.getAttribute("data-service-id");
        if (serviceId) openModal(serviceId, target);
      });
    });

    closeButton?.addEventListener("click", closeModal);
    modal.addEventListener("click", (event) => {
      if (event.target === modal) closeModal();
    });

    document.addEventListener("keydown", (event) => {
      if (modal.getAttribute("aria-hidden") === "true") return;
      if (event.key === "Escape") closeModal();
      trapFocus(event);
    });

    ctaButton?.addEventListener("click", () => {
      const interestInput = document.querySelector("#serviceInterest");
      if (interestInput && activeService) {
        interestInput.value = activeService.title || "";
      }
      closeModal();
      const contactSection = document.querySelector("#contacto");
      contactSection?.scrollIntoView({ behavior: "smooth" });
    });
  };

  if (document.readyState === "loading") {
    document.addEventListener("DOMContentLoaded", setupModal);
  } else {
    setupModal();
  }
</script>
