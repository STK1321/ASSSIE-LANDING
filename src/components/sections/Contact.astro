---
import Button from "@/components/atoms/Button.astro";
import Icon from "@/components/atoms/Icon.astro";
import SectionHeading from "@/components/molecules/SectionHeading.astro";
import { site } from "@/content/site";

const whatsappLink = `https://wa.me/${site.whatsapp.replace(/\D/g, "")}`;
---
<section id="contacto" class="py-20">
  <div class="mx-auto max-w-6xl px-6">
    <div class="grid gap-10 lg:grid-cols-[1.2fr_1fr]">
      <div class="space-y-6 reveal">
        <SectionHeading
          eyebrow="Contacto"
          title="Hablemos de tu objetivo"
          subtitle="Cuéntanos tu reto principal y te respondemos con un plan claro y accionable."
        />
        <div class="rounded-3xl border border-slate/10 bg-white p-6 shadow-card">
          <form id="lead-form" class="space-y-4" method="post" action="/api/lead" novalidate>
            <input id="serviceInterest" name="serviceInterest" type="hidden" />
            <div>
              <label class="text-sm font-semibold text-ink" for="name">Nombre</label>
              <input class="mt-2 w-full rounded-xl border border-slate/20 bg-white px-4 py-3 text-sm" id="name" name="name" type="text" required />
            </div>
            <div>
              <label class="text-sm font-semibold text-ink" for="company">Empresa</label>
              <input class="mt-2 w-full rounded-xl border border-slate/20 bg-white px-4 py-3 text-sm" id="company" name="company" type="text" required />
            </div>
            <div>
              <label class="text-sm font-semibold text-ink" for="goal">¿Qué problema quieres resolver?</label>
              <textarea class="mt-2 w-full rounded-xl border border-slate/20 bg-white px-4 py-3 text-sm" id="goal" name="goal" rows="3" required></textarea>
            </div>
            <div>
              <label class="text-sm font-semibold text-ink" for="companySize">Tamaño aproximado de la empresa (opcional)</label>
              <select class="mt-2 w-full rounded-xl border border-slate/20 bg-white px-4 py-3 text-sm" id="companySize" name="companySize">
                <option value="">Selecciona un rango</option>
                <option value="1-10">1-10</option>
                <option value="11-50">11-50</option>
                <option value="51-200">51-200</option>
                <option value="201-1000">201-1000</option>
                <option value="1000+">1000+</option>
              </select>
            </div>
            <div class="flex flex-wrap gap-3 pt-2">
              <Button as="button" type="submit" variant="primary" data-submit>
                Enviar solicitud
              </Button>
              <Button variant="ghost" href={whatsappLink} target="_blank" rel="noopener">
                <Icon name="whatsapp" class="h-4 w-4" />
                WhatsApp
              </Button>
            </div>
            <p class="text-xs text-slate" data-submit-status aria-live="polite" role="status"></p>
            <p class="text-xs text-slate">
              Sin spam. Respuesta en 24-48h.
            </p>
          </form>
        </div>
      </div>
      <div class="space-y-4 reveal" style="--reveal-delay: 120ms;">
        <div class="rounded-3xl border border-slate/10 bg-white p-6 shadow-card">
          <h3 class="text-lg font-semibold text-ink">Contacto directo</h3>
          <p class="mt-2 text-sm text-slate">Email: {site.email}</p>
          <p class="mt-1 text-sm text-slate">WhatsApp: {site.whatsapp}</p>
          <p class="mt-1 text-sm text-slate">Zona: {site.address}</p>
        </div>
        <div class="rounded-3xl border border-slate/10 bg-white p-6 shadow-card">
          <h3 class="text-lg font-semibold text-ink">Lo que incluye la llamada</h3>
          <ul class="mt-3 space-y-2 text-sm text-slate">
            <li class="flex gap-2">
              <svg
                viewBox="0 0 24 24"
                class="h-4 w-4 shrink-0 text-accent"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <path d="M5 13l4 4L19 7"></path>
              </svg>
              <span>Revisión de objetivos y procesos actuales.</span>
            </li>
            <li class="flex gap-2">
              <svg
                viewBox="0 0 24 24"
                class="h-4 w-4 shrink-0 text-accent"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <path d="M5 13l4 4L19 7"></path>
              </svg>
              <span>Propuesta inicial de automatización y data.</span>
            </li>
            <li class="flex gap-2">
              <svg
                viewBox="0 0 24 24"
                class="h-4 w-4 shrink-0 text-accent"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                aria-hidden="true"
              >
                <path d="M5 13l4 4L19 7"></path>
              </svg>
              <span>Estimación de tiempos y próximos pasos.</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <script is:inline>
    const form = document.getElementById("lead-form");
    const status = form?.querySelector("[data-submit-status]");
    const submitButton = form?.querySelector("[data-submit]");

    const statusClasses = {
      loading: "text-slate",
      success: "text-emerald-600",
      error: "text-rose-600"
    };

    const setStatus = (state, message) => {
      if (!status) return;
      status.textContent = message;
      status.dataset.state = state;
      status.classList.remove("text-slate", "text-emerald-600", "text-rose-600");
      status.classList.add(statusClasses[state] ?? "text-slate");
    };

    form?.addEventListener("submit", async (event) => {
      event.preventDefault();
      if (!form || !submitButton) return;

      submitButton.setAttribute("disabled", "true");
      setStatus("loading", "Enviando solicitud...");

      const formData = new FormData(form);
      const interest = formData.get("serviceInterest")?.toString() ?? "";

      try {
        const response = await fetch(form.action, {
          method: "POST",
          body: formData
        });

        if (!response.ok) throw new Error("Request failed");

        form.reset();
        if (interest) {
          const interestInput = form.querySelector("#serviceInterest");
          if (interestInput) interestInput.value = interest;
        }
        setStatus("success", "Listo. Te contactaremos en breve.");
      } catch (error) {
        setStatus("error", "No pudimos enviar tu solicitud. Intentalo nuevamente.");
      } finally {
        submitButton.removeAttribute("disabled");
      }
    });
  </script>
</section>
